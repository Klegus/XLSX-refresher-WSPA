<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 1.2em;
            padding: 0.5em 1em;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">System Administration Panel</h1>
        
        <!-- Status Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">System Status</h2>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-success status-badge" id="statusBadge">Active</span>
                        <p class="text-muted mt-2" id="lastCheck">Last check: </p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="maintenanceMode">
                        <label class="form-check-label" for="maintenanceMode">Maintenance Mode</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Check Interval Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">Check Interval Settings</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="checkInterval" class="form-label">Check Interval (seconds)</label>
                    <input type="number" class="form-control" id="checkInterval" min="60" step="60">
                </div>
                <button class="btn btn-primary" onclick="updateInterval()">Update Interval</button>
            </div>
        </div>

        <!-- Plans Management Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">Plans Management</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h3 class="h5">Current Plans</h3>
                    <div id="currentPlans" class="list-group mb-3">
                        <!-- Plans will be loaded here -->
                    </div>
                </div>
                <div class="mb-3">
                    <h3 class="h5">Add New Plan</h3>
                    <div class="mb-3">
                        <label for="planJson" class="form-label">Plan Configuration (JSON)</label>
                        <textarea class="form-control" id="planJson" rows="10"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="addPlan()">Add Plan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            loadStatus();
            loadConfig();
            loadPlans();
        });

        // Refresh status every 30 seconds
        setInterval(loadStatus, 30000);

        function loadStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusBadge = document.getElementById('statusBadge');
                    statusBadge.textContent = data.status === 'active' ? 'Active' : 'Inactive';
                    statusBadge.className = `badge status-badge ${data.status === 'active' ? 'bg-success' : 'bg-danger'}`;
                    
                    document.getElementById('lastCheck').textContent = `Last check: ${data.last_check}`;
                    document.getElementById('maintenanceMode').checked = data.maintenance_mode;
                });
        }

        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('checkInterval').value = data.system_config.check_interval;
                });
        }

        function loadPlans() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    const plansContainer = document.getElementById('currentPlans');
                    plansContainer.innerHTML = '';
                    
                    if (data.plans_config) {
                        Object.entries(data.plans_config).forEach(([name, plan]) => {
                            const planElement = document.createElement('div');
                            planElement.className = 'list-group-item d-flex justify-content-between align-items-center';
                            planElement.innerHTML = `
                                <div>
                                    <h5 class="mb-1">${name}</h5>
                                    <small class="text-muted">URL: ${plan.download_url || 'N/A'}</small>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="deletePlan('${name}')">Delete</button>
                            `;
                            plansContainer.appendChild(planElement);
                        });
                    }
                });
        }

        function updateInterval() {
            const interval = document.getElementById('checkInterval').value;
            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    system_config: {
                        check_interval: parseInt(interval)
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                alert('Check interval updated successfully');
                loadConfig();
            })
            .catch(error => alert('Error updating check interval'));
        }

        document.getElementById('maintenanceMode').addEventListener('change', function(e) {
            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    system_config: {
                        maintenance_mode: e.target.checked
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                loadStatus();
            })
            .catch(error => alert('Error updating maintenance mode'));
        });

        function addPlan() {
            const planJson = document.getElementById('planJson').value;
            try {
                const planData = JSON.parse(planJson);
                fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plans_config: planData
                    })
                })
                .then(response => response.json())
                .then(data => {
                    alert('Plan added successfully');
                    loadPlans();
                    document.getElementById('planJson').value = '';
                })
                .catch(error => alert('Error adding plan'));
            } catch (e) {
                alert('Invalid JSON format');
            }
        }

        function deletePlan(planName) {
            if (confirm(`Are you sure you want to delete plan "${planName}"?`)) {
                fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plans_config: {
                            [planName]: null
                        }
                    })
                })
                .then(response => response.json())
                .then(data => {
                    alert('Plan deleted successfully');
                    loadPlans();
                })
                .catch(error => alert('Error deleting plan'));
            }
        }
    </script>
</body>
</html>
