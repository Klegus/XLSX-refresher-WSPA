<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 1.2em;
            padding: 0.5em 1em;
        }
    </style>
</head>
<body>
    <div class="container mt-5" id="mainContainer">
        <!-- Search Bar -->
        <div class="mb-4">
            <input type="text" class="form-control" id="planSearch" placeholder="Search plans...">
        </div>
        <h1 class="mb-4">System Administration Panel</h1>
        
        <!-- Status Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">System Status</h2>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-success status-badge" id="statusBadge">Active</span>
                        <p class="text-muted mt-2" id="lastCheck">Last check: </p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="maintenanceMode">
                        <label class="form-check-label" for="maintenanceMode">Maintenance Mode</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Check Interval Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">Check Interval Settings</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="checkInterval" class="form-label">Check Interval (seconds)</label>
                    <input type="number" class="form-control" id="checkInterval" min="60" step="60">
                </div>
                <button class="btn btn-primary" onclick="updateInterval()">Update Interval</button>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="h4 mb-0">System Logs</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Successful Checks</th>
                                <th>New Plans</th>
                                <th>Has Errors</th>
                                <th>Execution Time (s)</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="logsTable">
                            <!-- Logs will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Plans Management Section -->
        <div class="card mb-4" id="plansSection">
            <div class="card-header">
                <h2 class="h4 mb-0">Plans Management</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h3 class="h5">Current Plans</h3>
                    <div id="currentPlans" class="list-group mb-3">
                        <!-- Plans will be loaded here -->
                    </div>
                </div>
                <div class="mb-3">
                    <h3 class="h5">Add New Plan</h3>
                    <div class="mb-3">
                        <label for="planJson" class="form-label">Plan Configuration (JSON)</label>
                        <textarea class="form-control" id="planJson" rows="10"></textarea>
                    </div>
                    <button class="btn btn-success" onclick="addPlan()">Add Plan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Plan Modal -->
    <div class="modal fade" id="editPlanModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="form-control" id="editPlanJson" rows="15"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="savePlanEdit()">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEditPlanName = null;
        // Error display function
        function showErrors(errors) {
            const errorMessages = errors.map(error => 
                `Plan: ${error.plan_name}\nError: ${error.error_message}\n\nStacktrace:\n${error.traceback}`
            ).join('\n\n-------------------\n\n');
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Error Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre class="text-danger" style="white-space: pre-wrap;">${errorMessages}</pre>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        // Search functionality
        document.getElementById('planSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const plans = document.querySelectorAll('#currentPlans .list-group-item');
            
            plans.forEach(plan => {
                const planName = plan.querySelector('h5').textContent.toLowerCase();
                const planUrl = plan.querySelector('small').textContent.toLowerCase();
                const matches = planName.includes(searchTerm) || planUrl.includes(searchTerm);
                plan.style.display = matches ? '' : 'none';
            });
        });

        function checkMaintenanceMode() {
            const isMaintenanceMode = document.getElementById('maintenanceMode').checked;
            const plansSection = document.getElementById('plansSection');
            const checkIntervalCard = document.querySelector('.card:nth-child(2)');
            
            if (isMaintenanceMode) {
                plansSection.style.display = 'none';
                checkIntervalCard.style.display = 'none';
            } else {
                plansSection.style.display = 'block';
                checkIntervalCard.style.display = 'block';
            }
        }

        function loadLogs() {
            fetch('/api/logs')
                .then(response => response.json())
                .then(logs => {
                    const logsTable = document.getElementById('logsTable');
                    logsTable.innerHTML = '';
                    logs.forEach(log => {
                        const row = document.createElement('tr');
                        const hasErrors = log.has_errors;
                        row.innerHTML = `
                            <td>${new Date(log.timestamp).toLocaleString()}</td>
                            <td>${log.successful_checks}</td>
                            <td>${log.new_plans}</td>
                            <td><span class="badge ${hasErrors ? 'bg-danger' : 'bg-success'}">${hasErrors ? 'Yes' : 'No'}</span></td>
                            <td>${log.execution_time || 'N/A'}</td>
                            <td>
                                ${hasErrors ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick='showErrors(${JSON.stringify(log.errors)})'>
                                        Show Errors
                                    </button>
                                ` : '-'}
                            </td>
                        `;
                        logsTable.appendChild(row);
                    });
                });
        }

        function editPlan(name, plan) {
            currentEditPlanName = name;
            document.getElementById('editPlanJson').value = JSON.stringify(plan, null, 2);
            new bootstrap.Modal(document.getElementById('editPlanModal')).show();
        }

        function savePlanEdit() {
            const planJson = document.getElementById('editPlanJson').value;
            try {
                const planData = JSON.parse(planJson);
                fetch('/api/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plans_config: {
                            [currentEditPlanName]: planData
                        }
                    })
                })
                .then(response => response.json())
                .then(data => {
                    bootstrap.Modal.getInstance(document.getElementById('editPlanModal')).hide();
                    alert('Plan updated successfully');
                    loadPlans();
                })
                .catch(error => alert('Error updating plan'));
            } catch (e) {
                alert('Invalid JSON format');
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            loadStatus();
            loadConfig();
            loadPlans();
            loadLogs();
            checkMaintenanceMode();
        });

        // Refresh status every 30 seconds
        setInterval(loadStatus, 30000);

        function loadStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const statusBadge = document.getElementById('statusBadge');
                    statusBadge.textContent = data.status === 'active' ? 'Active' : 'Inactive';
                    statusBadge.className = `badge status-badge ${data.status === 'active' ? 'bg-success' : 'bg-danger'}`;
                    
                    document.getElementById('lastCheck').textContent = `Last check: ${data.last_check}`;
                    document.getElementById('maintenanceMode').checked = data.maintenance_mode;
                });
        }

        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('checkInterval').value = data.system_config.check_interval;
                });
        }

        function loadPlans() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    const plansContainer = document.getElementById('currentPlans');
                    plansContainer.innerHTML = '';
                    
                    if (data.plans_config) {
                        Object.entries(data.plans_config).forEach(([name, plan]) => {
                            const planElement = document.createElement('div');
                            planElement.className = 'list-group-item d-flex justify-content-between align-items-center';
                            planElement.innerHTML = `
                                <div>
                                    <h5 class="mb-1">${name}</h5>
                                    <small class="text-muted">URL: ${plan.download_url || 'N/A'}</small>
                                </div>
                                <div>
                                    <button class="btn btn-primary btn-sm me-2" onclick="editPlan('${name}', ${JSON.stringify(plan).replace(/"/g, '&quot;')})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deletePlan('${name}')">Delete</button>
                                </div>
                            `;
                            plansContainer.appendChild(planElement);
                        });
                    }
                });
        }

        function updateInterval() {
            const interval = document.getElementById('checkInterval').value;
            fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    system_config: {
                        check_interval: parseInt(interval)
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                alert('Check interval updated successfully');
                loadConfig();
            })
            .catch(error => alert('Error updating check interval'));
        }

        // Refresh logs every minute
        setInterval(loadLogs, 60000);

        document.getElementById('maintenanceMode').addEventListener('change', function(e) {
            checkMaintenanceMode();
            fetch('/api/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    maintenance_mode: e.target.checked
                })
            })
            .then(response => response.json())
            .then(data => {
                loadStatus();
            })
            .catch(error => alert('Error updating maintenance mode'));
        });

        function addPlan() {
            const planJson = document.getElementById('planJson').value;
            try {
                const planData = JSON.parse(planJson);
                fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plans_config: planData
                    })
                })
                .then(response => response.json())
                .then(data => {
                    alert('Plan added successfully');
                    loadPlans();
                    document.getElementById('planJson').value = '';
                })
                .catch(error => alert('Error adding plan'));
            } catch (e) {
                alert('Invalid JSON format');
            }
        }

        function deletePlan(planName) {
            if (confirm(`Are you sure you want to delete plan "${planName}"?`)) {
                fetch(`/api/plan/${planName}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    alert('Plan deleted successfully');
                    loadPlans();
                })
                .catch(error => alert('Error deleting plan'));
            }
        }
    </script>
</body>
</html>
